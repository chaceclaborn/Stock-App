<!-- API Module -->
<script>
  // stock-api.js - API Communication Module
  const StockAPI = {
    config: {
      baseURL: "/api",
      timeout: 30000,
    },

    async call(endpoint, options = {}) {
      try {
        const response = await axios.get(
          `${this.config.baseURL}${endpoint}`,
          options
        );

        if (response.data.status === "success") {
          return response.data;
        } else if (response.data.status === "error") {
          throw new Error(response.data.error || "API Error");
        } else {
          return response.data;
        }
      } catch (error) {
        console.error(`API Error on ${endpoint}:`, error);
        throw error;
      }
    },

    async getStocks(category = "all", forceRefresh = false) {
      return this.call(`/stocks?category=${category}&force=${forceRefresh}`);
    },

    async getCachedStocks() {
      return this.call("/stocks/cached");
    },

    async getStockDetail(symbol) {
      return this.call(`/stock/${symbol}`);
    },

    async getStockAnalysis(symbol) {
      return this.call(`/stock/${symbol}/analysis`);
    },

    async searchStocks(query) {
      return this.call(`/search?q=${encodeURIComponent(query)}`);
    },

    async getMarketOverview() {
      return this.call("/market-overview");
    },

    async getPredictions() {
      return this.call("/predictions");
    },

    async getDebugInfo() {
      return this.call("/debug");
    },
  };
</script>

<!-- UI Module -->
<script>
  // stock-ui.js - UI Management Module
  const StockUI = {
    currentTab: "overview",

    showLoading(containerId, message = "Loading...") {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = `<div class="loading">${message}</div>`;
      }
    },

    showError(containerId, message, details = null) {
      const container = document.getElementById(containerId);
      if (container) {
        let errorHtml = `<div class="error">${message}`;
        if (details) {
          errorHtml += `<br><small style="opacity: 0.7">${details}</small>`;
        }
        errorHtml += `</div>`;
        container.innerHTML = errorHtml;
      }
    },

    formatTimeAgo(timestamp) {
      const now = new Date();
      const then = new Date(timestamp);
      const seconds = Math.floor((now - then) / 1000);

      if (seconds < 60) return `${seconds} seconds ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} minute${minutes > 1 ? "s" : ""} ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
      const days = Math.floor(hours / 24);
      return `${days} day${days > 1 ? "s" : ""} ago`;
    },

    updateLastUpdated(tabId, timestamp, isCache = false) {
      const element = document.getElementById(`${tabId}LastUpdated`);
      if (element) {
        const timeAgo = this.formatTimeAgo(timestamp);
        const cacheIndicator = isCache
          ? '<span class="data-status">Cached</span>'
          : "";
        element.innerHTML = `Last updated: ${timeAgo} ${cacheIndicator}`;
      }
    },

    createStockCard(stock) {
      const changeClass = stock.change >= 0 ? "positive" : "negative";
      const arrow = stock.change >= 0 ? "▲" : "▼";

      return `
            <div class="stock-card" onclick="StockDetail.show('${
              stock.symbol
            }')">
                <div class="stock-symbol">${stock.symbol}</div>
                <div class="stock-name">${stock.name || stock.symbol}</div>
                <div class="stock-price">$${stock.price.toFixed(2)}</div>
                <div class="stock-change ${changeClass}">
                    ${arrow} ${Math.abs(stock.change).toFixed(2)} (${
        stock.change_percent
      })
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #aaa;">
                    Volume: ${(stock.volume / 1000000).toFixed(2)}M
                </div>
            </div>
        `;
    },

    displayStocks(stocks, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (!stocks || stocks.length === 0) {
        container.innerHTML = '<div class="error">No stocks to display</div>';
        return;
      }

      container.innerHTML = stocks
        .map((stock) => this.createStockCard(stock))
        .join("");
    },

    updateSentimentMeter(fearGreedIndex) {
      const indicator = document.getElementById("sentimentIndicator");
      if (!indicator) return;

      const position = (fearGreedIndex / 100) * 80 + 10;
      indicator.style.left = `${position}%`;

      if (fearGreedIndex < 20) {
        indicator.style.background = "#f00";
        indicator.style.boxShadow = "0 0 10px #f00";
      } else if (fearGreedIndex < 40) {
        indicator.style.background = "#ff0";
        indicator.style.boxShadow = "0 0 10px #ff0";
      } else if (fearGreedIndex < 60) {
        indicator.style.background = "#fff";
        indicator.style.boxShadow = "0 0 10px #fff";
      } else if (fearGreedIndex < 80) {
        indicator.style.background = "#0f0";
        indicator.style.boxShadow = "0 0 10px #0f0";
      } else {
        indicator.style.background = "#0f0";
        indicator.style.boxShadow = "0 0 20px #0f0";
      }
    },

    displayMarketIndices(indices) {
      let html = "";

      for (const [name, data] of Object.entries(indices)) {
        if (name === "fear_greed_index") continue;

        const changeClass = data.change >= 0 ? "positive" : "negative";
        const arrow = data.change >= 0 ? "▲" : "▼";

        html += `
                <div class="indicator-card">
                    <div class="indicator-label">${name}</div>
                    <div class="indicator-value">${data.value.toFixed(2)}</div>
                    <div class="${changeClass}">
                        ${arrow} ${Math.abs(data.change).toFixed(
          2
        )} (${data.change_percent.toFixed(2)}%)
                    </div>
                </div>
            `;
      }

      const container = document.getElementById("marketIndices");
      if (container) {
        container.innerHTML = html;
      }
    },
  };
</script>

<!-- Portfolio Module -->
<script>
  // stock-portfolio.js - Portfolio Management Module
  const StockPortfolio = {
    portfolio: {},

    init() {
      this.portfolio = JSON.parse(localStorage.getItem("stockPortfolio")) || {};
    },

    save() {
      localStorage.setItem("stockPortfolio", JSON.stringify(this.portfolio));
    },

    add(symbol, shares, price) {
      symbol = symbol.toUpperCase();

      if (!symbol || !shares || !price || shares <= 0 || price <= 0) {
        alert("Please enter valid symbol, shares, and price");
        return false;
      }

      if (this.portfolio[symbol]) {
        const totalShares = this.portfolio[symbol].shares + shares;
        const totalCost =
          this.portfolio[symbol].shares * this.portfolio[symbol].avgPrice +
          shares * price;
        this.portfolio[symbol] = {
          shares: totalShares,
          avgPrice: totalCost / totalShares,
        };
      } else {
        this.portfolio[symbol] = {
          shares: shares,
          avgPrice: price,
        };
      }

      this.save();
      return true;
    },

    remove(symbol) {
      if (confirm(`Remove ${symbol} from portfolio?`)) {
        delete this.portfolio[symbol];
        this.save();
        return true;
      }
      return false;
    },

    async display(cachedStocks) {
      const container = document.getElementById("portfolioGrid");

      if (Object.keys(this.portfolio).length === 0) {
        container.innerHTML =
          '<div class="no-portfolio">No stocks in portfolio. Add some to get started!</div>';
        this.updateSummary(0, 0, 0);
        return;
      }

      let html = "";
      let totalValue = 0;
      let totalCost = 0;
      let dayChange = 0;

      for (const [symbol, holding] of Object.entries(this.portfolio)) {
        let currentPrice = 0;
        let change = 0;
        let changePercent = "0.00%";

        if (cachedStocks[symbol]) {
          currentPrice = cachedStocks[symbol].price;
          change = cachedStocks[symbol].change;
          changePercent = cachedStocks[symbol].change_percent;
        }

        const currentValue = currentPrice * holding.shares;
        const costBasis = holding.avgPrice * holding.shares;
        const gain = currentValue - costBasis;
        const gainPercent = costBasis > 0 ? (gain / costBasis) * 100 : 0;

        totalValue += currentValue;
        totalCost += costBasis;
        dayChange += change * holding.shares;

        const gainClass = gain >= 0 ? "positive" : "negative";

        html += `
                <div class="portfolio-stock-card">
                    <button class="remove-from-portfolio" onclick="StockPortfolio.removeAndRefresh('${symbol}')">×</button>
                    <div class="stock-symbol">${symbol}</div>
                    <div class="stock-name">${
                      holding.shares
                    } shares @ $${holding.avgPrice.toFixed(2)}</div>
                    <div class="stock-price">$${currentPrice.toFixed(2)}</div>
                    <div class="stock-change ${gainClass}">
                        P/L: $${gain.toFixed(2)} (${gainPercent.toFixed(2)}%)
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        Value: $${currentValue.toFixed(2)}
                    </div>
                </div>
            `;
      }

      container.innerHTML = html;

      const totalReturn =
        totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0;
      this.updateSummary(totalValue, dayChange, totalReturn);
    },

    updateSummary(totalValue, dayChange, totalReturn) {
      document.getElementById(
        "portfolioTotalValue"
      ).textContent = `$${totalValue.toFixed(2)}`;

      const dayChangeEl = document.getElementById("portfolioDayChange");
      dayChangeEl.textContent = `$${dayChange.toFixed(2)}`;
      dayChangeEl.className =
        dayChange >= 0
          ? "indicator-value positive"
          : "indicator-value negative";

      const totalReturnEl = document.getElementById("portfolioTotalReturn");
      totalReturnEl.textContent = `${totalReturn.toFixed(2)}%`;
      totalReturnEl.className =
        totalReturn >= 0
          ? "indicator-value positive"
          : "indicator-value negative";
    },

    addFromForm() {
      const symbol = document
        .getElementById("portfolioAddSymbol")
        .value.toUpperCase();
      const shares = parseInt(
        document.getElementById("portfolioAddShares").value
      );
      const price = parseFloat(
        document.getElementById("portfolioAddPrice").value
      );

      if (this.add(symbol, shares, price)) {
        document.getElementById("portfolioAddSymbol").value = "";
        document.getElementById("portfolioAddShares").value = "";
        document.getElementById("portfolioAddPrice").value = "";
        StockApp.loadPortfolio();
      }
    },

    removeAndRefresh(symbol) {
      if (this.remove(symbol)) {
        StockApp.loadPortfolio();
      }
    },
  };

  // Make addToPortfolio global for onclick
  window.addToPortfolio = function () {
    StockPortfolio.addFromForm();
  };

  // Make removeFromPortfolio global for onclick
  window.removeFromPortfolio = function (symbol) {
    StockPortfolio.removeAndRefresh(symbol);
  };
</script>

<!-- Stock Detail Module -->
<script>
  // stock-detail.js - Stock Detail Modal Module
  const StockDetail = {
    chartInstance: null,

    async show(symbol) {
      document.getElementById("stockModal").style.display = "block";
      StockUI.showLoading("modalContent", "Loading stock details...");

      try {
        const [detailResponse, analysisResponse] = await Promise.all([
          StockAPI.getStockDetail(symbol),
          StockAPI.getStockAnalysis(symbol),
        ]);

        console.log("Detail response:", detailResponse);
        console.log("Analysis response:", analysisResponse);

        const stockData = detailResponse.data;
        const analysisData = analysisResponse.data;

        this.display(stockData, analysisData);
      } catch (error) {
        console.error("Error loading stock detail:", error);
        StockUI.showError(
          "modalContent",
          "Failed to load stock details",
          error.response?.data?.error || error.message
        );
      }
    },

    display(stockData, analysisData) {
      if (!stockData || !stockData.quote) {
        StockUI.showError("modalContent", "Invalid stock data received");
        return;
      }

      const changeClass = stockData.quote.change >= 0 ? "positive" : "negative";
      const arrow = stockData.quote.change >= 0 ? "▲" : "▼";

      const inPortfolio =
        StockPortfolio.portfolio[stockData.symbol] !== undefined;
      const portfolioButton = inPortfolio
        ? `<button onclick="StockPortfolio.removeAndRefresh('${stockData.symbol}'); StockDetail.close();" style="background: #f00;">Remove from Portfolio</button>`
        : `<button onclick="StockDetail.addToPortfolio('${stockData.symbol}', ${stockData.quote.price});">Add to Portfolio</button>`;

      let html = `
            <h2>${stockData.symbol} - ${stockData.name}</h2>
            <div style="margin-bottom: 20px;">${portfolioButton}</div>
            
            <div class="indicators-grid">
                <div class="indicator-card">
                    <div class="indicator-label">Current Price</div>
                    <div class="indicator-value">$${stockData.quote.price.toFixed(
                      2
                    )}</div>
                    <div class="${changeClass}">
                        ${arrow} ${Math.abs(stockData.quote.change).toFixed(
        2
      )} (${stockData.quote.change_percent})
                    </div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">Volume</div>
                    <div class="indicator-value">${(
                      stockData.quote.volume / 1000000
                    ).toFixed(2)}M</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">RSI</div>
                    <div class="indicator-value">${
                      analysisData?.current_indicators?.rsi?.toFixed(2) || "N/A"
                    }</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">AI Score</div>
                    <div class="indicator-value" style="color: ${
                      (analysisData?.score || 0) >= 7
                        ? "#0f0"
                        : (analysisData?.score || 0) >= 5
                        ? "#ff0"
                        : "#f90"
                    }">
                        ${analysisData?.score || 0}/10
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
        `;

      if (analysisData) {
        html += this.renderAnalysis(analysisData);
      }

      if (stockData.fundamentals) {
        html += this.renderFundamentals(stockData.fundamentals);
      }

      if (stockData.news && stockData.news.length > 0) {
        html += this.renderNews(stockData.news);
      }

      document.getElementById("modalContent").innerHTML = html;

      if (stockData.daily_data && stockData.daily_data.length > 0) {
        this.drawChart(stockData.daily_data);
      }
    },

    renderAnalysis(analysisData) {
      return `
            <div class="analysis-section">
                <h3 class="analysis-header">AI Analysis</h3>
                <div style="margin-bottom: 15px;">
                    <strong>Signals Detected:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        ${(analysisData.reasons || [])
                          .map((r) => `<li>${r}</li>`)
                          .join("")}
                    </ul>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Entry/Exit Suggestions:</strong>
                    <div style="margin-top: 10px;">
                        Support Entry: $${
                          analysisData.suggestions?.support_entry?.toFixed(2) ||
                          "N/A"
                        }<br>
                        Resistance Exit: $${
                          analysisData.suggestions?.resistance_exit?.toFixed(
                            2
                          ) || "N/A"
                        }<br>
                        Stop Loss: $${
                          analysisData.suggestions?.stop_loss?.toFixed(2) ||
                          "N/A"
                        }
                    </div>
                </div>
            </div>
        `;
    },

    renderFundamentals(fundamentals) {
      return `
            <div class="analysis-section">
                <h3 class="analysis-header">Fundamentals</h3>
                <div class="indicators-grid">
                    <div class="indicator-card">
                        <div class="indicator-label">Market Cap</div>
                        <div class="indicator-value">$${(
                          fundamentals.market_cap / 1000000000
                        ).toFixed(2)}B</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">P/E Ratio</div>
                        <div class="indicator-value">${
                          fundamentals.pe_ratio?.toFixed(2) || "N/A"
                        }</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">52W High</div>
                        <div class="indicator-value">$${
                          fundamentals["52_week_high"]?.toFixed(2) || "N/A"
                        }</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">52W Low</div>
                        <div class="indicator-value">$${
                          fundamentals["52_week_low"]?.toFixed(2) || "N/A"
                        }</div>
                    </div>
                </div>
            </div>
        `;
    },

    renderNews(news) {
      return `
            <div class="analysis-section">
                <h3 class="analysis-header">Latest News</h3>
                <div class="news-section">
                    ${news
                      .slice(0, 3)
                      .map(
                        (item) => `
                        <div class="news-item">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">${
                              item.publisher
                            } - ${new Date(
                          item.timestamp * 1000
                        ).toLocaleDateString()}</div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            </div>
        `;
    },

    drawChart(priceData) {
      const ctx = document.getElementById("stockChart").getContext("2d");

      if (this.chartInstance) {
        this.chartInstance.destroy();
      }

      const labels = priceData.map((d) => d.date);
      const prices = priceData.map((d) => d.close);
      const volumes = priceData.map((d) => d.volume);

      this.chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Price",
              data: prices,
              borderColor: "#0f0",
              backgroundColor: "rgba(0, 255, 0, 0.1)",
              borderWidth: 2,
              tension: 0.4,
              yAxisID: "y-price",
            },
            {
              label: "Volume",
              data: volumes,
              type: "bar",
              backgroundColor: "rgba(0, 255, 0, 0.3)",
              yAxisID: "y-volume",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              labels: { color: "#0f0" },
            },
          },
          scales: {
            x: {
              display: true,
              grid: { color: "rgba(0, 255, 0, 0.1)" },
              ticks: { color: "#0f0", maxRotation: 45, minRotation: 45 },
            },
            "y-price": {
              type: "linear",
              display: true,
              position: "left",
              grid: { color: "rgba(0, 255, 0, 0.1)" },
              ticks: { color: "#0f0" },
            },
            "y-volume": {
              type: "linear",
              display: true,
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: { color: "#0f0" },
            },
          },
        },
      });
    },

    addToPortfolio(symbol, price) {
      document.getElementById("portfolioAddSymbol").value = symbol;
      document.getElementById("portfolioAddPrice").value = price;
      this.close();
      const portfolioTab = document.querySelector('[onclick*="portfolio"]');
      if (portfolioTab) portfolioTab.click();
    },

    close() {
      document.getElementById("stockModal").style.display = "none";
      if (this.chartInstance) {
        this.chartInstance.destroy();
        this.chartInstance = null;
      }
    },
  };

  // Make showStockDetail global for onclick
  window.showStockDetail = function (symbol) {
    StockDetail.show(symbol);
  };

  // Make closeModal global for onclick
  window.closeModal = function () {
    StockDetail.close();
  };
</script>

<!-- Main App Controller -->
<script>
  // stock-app.js - Main Application Controller
  const StockApp = {
    updateInterval: null,
    cachedStocks: {},

    async init() {
      console.log("Initializing Stock Analyzer...");

      StockPortfolio.init();

      await this.loadCachedStocks();
      this.loadMarketOverview();
      this.loadStocks("all");
      this.loadPredictions();
      this.loadPortfolio();

      this.updateInterval = setInterval(() => {
        const currentTab = StockUI.currentTab;
        if (currentTab === "overview") {
          this.loadMarketOverview();
        } else if (currentTab === "predictions") {
          this.loadPredictions();
        } else if (currentTab === "portfolio") {
          this.loadPortfolio();
        } else {
          this.loadStocks(currentTab);
        }
      }, 30000);

      this.setupEventHandlers();
      setTimeout(() => this.checkAPIStatus(), 1000);
    },

    setupEventHandlers() {
      document
        .getElementById("stockSearch")
        ?.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            this.searchStocks();
          }
        });

      window.onclick = (event) => {
        const modal = document.getElementById("stockModal");
        if (event.target === modal) {
          StockDetail.close();
        }
      };
    },

    switchTab(tab) {
      document
        .querySelectorAll(".tab")
        .forEach((t) => t.classList.remove("active"));
      if (event && event.target) {
        event.target.classList.add("active");
      }

      document
        .querySelectorAll(".content-section")
        .forEach((s) => s.classList.remove("active"));
      document.getElementById(tab).classList.add("active");

      StockUI.currentTab = tab;

      switch (tab) {
        case "overview":
          this.loadMarketOverview();
          break;
        case "predictions":
          this.loadPredictions();
          break;
        case "portfolio":
          this.loadPortfolio();
          break;
        default:
          this.loadStocks(tab);
      }
    },

    async loadCachedStocks() {
      try {
        console.log("Loading cached stocks...");
        const response = await StockAPI.getCachedStocks();

        if (response.data && response.data.length > 0) {
          this.cachedStocks = {};
          response.data.forEach((stock) => {
            this.cachedStocks[stock.symbol] = stock;
          });

          if (StockUI.currentTab === "all") {
            StockUI.displayStocks(response.data, "allGrid");
            StockUI.updateLastUpdated(
              "all",
              response.last_updated || new Date().toISOString(),
              true
            );
          }

          console.log(`Loaded ${response.data.length} cached stocks`);
        }
      } catch (error) {
        console.error("Error loading cached stocks:", error);
      }
    },

    async loadStocks(category) {
      try {
        console.log(`Loading stocks for category: ${category}`);

        if (Object.keys(this.cachedStocks).length > 0) {
          const cachedArray = Object.values(this.cachedStocks);
          StockUI.displayStocks(cachedArray, "allGrid");
          StockUI.updateLastUpdated("all", new Date().toISOString(), true);
        }

        const response = await StockAPI.getStocks(category);

        if (response.data && response.data.length > 0) {
          StockUI.displayStocks(response.data, "allGrid");
          StockUI.updateLastUpdated(
            category,
            response.last_updated || new Date().toISOString(),
            response.from_cache
          );

          response.data.forEach((stock) => {
            this.cachedStocks[stock.symbol] = stock;
          });

          console.log(`Loaded ${response.data.length} stocks`);
        }
      } catch (error) {
        console.error("Error loading stocks:", error);

        if (Object.keys(this.cachedStocks).length > 0) {
          const cachedArray = Object.values(this.cachedStocks);
          StockUI.displayStocks(cachedArray, "allGrid");
        } else {
          StockUI.showError(
            "allGrid",
            "Failed to load stock data",
            error.message
          );
        }
      }
    },

    async loadMarketOverview() {
      try {
        console.log("Loading market overview...");
        const response = await StockAPI.getMarketOverview();

        if (response.data) {
          if (response.data.indices) {
            StockUI.displayMarketIndices(response.data.indices);
            if (response.data.indices.fear_greed_index !== undefined) {
              StockUI.updateSentimentMeter(
                response.data.indices.fear_greed_index
              );
            }
          }
          StockUI.updateLastUpdated(
            "overview",
            response.timestamp || new Date().toISOString()
          );
        }
      } catch (error) {
        console.error("Error loading market overview:", error);
        StockUI.showError(
          "marketIndices",
          "Failed to load market data",
          error.message
        );
      }
    },

    async loadPredictions() {
      try {
        console.log("Loading AI predictions...");
        const response = await StockAPI.getPredictions();

        if (response.data?.opportunities?.length > 0) {
          this.displayPredictions(response.data.opportunities);
          StockUI.updateLastUpdated(
            "predictions",
            response.data.generated_at || new Date().toISOString()
          );
        } else {
          document.getElementById("predictionsGrid").innerHTML =
            '<div class="analysis-section">No strong trading signals detected at this time. The AI is continuously analyzing market patterns.</div>';
          StockUI.updateLastUpdated("predictions", new Date().toISOString());
        }
      } catch (error) {
        console.error("Error loading predictions:", error);
        StockUI.showError(
          "predictionsGrid",
          "Failed to load AI predictions",
          error.message
        );
      }
    },

    displayPredictions(opportunities) {
      let html = "";

      opportunities.forEach((opp) => {
        const scoreColor =
          opp.score >= 7 ? "#0f0" : opp.score >= 5 ? "#ff0" : "#f90";

        html += `
                <div class="stock-card" onclick="StockDetail.show('${
                  opp.ticker
                }')">
                    <div class="stock-symbol">${opp.ticker}</div>
                    <div class="stock-name">${opp.name || opp.ticker}</div>
                    <div class="stock-price">$${opp.price.toFixed(2)}</div>
                    <div style="margin: 10px 0; padding: 10px; background: rgba(0,255,0,0.1); border-radius: 5px;">
                        <div style="color: ${scoreColor}; font-weight: bold; margin-bottom: 5px;">
                            Score: ${opp.score}/10
                        </div>
                        <div style="font-size: 12px; color: #aaa;">
                            ${opp.reasons[0]}
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #0f0;">
                        ${opp.strategy?.recommendation || "BUY"}
                    </div>
                </div>
            `;
      });

      document.getElementById("predictionsGrid").innerHTML = html;
    },

    loadPortfolio() {
      StockPortfolio.display(this.cachedStocks);
      StockUI.updateLastUpdated("portfolio", new Date().toISOString());
    },

    async searchStocks() {
      const query = document.getElementById("stockSearch").value.trim();
      if (!query) return;

      try {
        const response = await StockAPI.searchStocks(query);
        const results = response.data.results;

        if (results.length > 0) {
          StockUI.displayStocks(results, "allGrid");
          this.switchTab("all");
        } else {
          alert("No stocks found matching your search");
        }
      } catch (error) {
        console.error("Error searching stocks:", error);
        alert("Error searching stocks");
      }
    },

    clearSearch() {
      document.getElementById("stockSearch").value = "";
      this.loadStocks("all");
    },

    async checkAPIStatus() {
      try {
        const response = await StockAPI.getDebugInfo();
        console.log("API Debug Info:", response.data);
      } catch (error) {
        console.error("API Debug failed:", error);
      }
    },
  };

  // Make switchTab global for onclick
  window.switchTab = function (tab) {
    StockApp.switchTab(tab);
  };

  // Make searchStocks global for onclick
  window.searchStocks = function () {
    StockApp.searchStocks();
  };

  // Make clearSearch global for onclick
  window.clearSearch = function () {
    StockApp.clearSearch();
  };

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    StockApp.init();
  });
</script>
